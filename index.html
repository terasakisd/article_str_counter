<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記事文字数カウンター</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FAFAFA;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            border: 1px solid #E5E7EB;
        }
        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: #6B7280;
            margin-bottom: 1.5rem;
        }
        .mode-selector {
            margin-bottom: 1rem;
            display: flex;
            gap: 1.5rem;
        }
        .mode-selector label {
            cursor: pointer;
            display: flex;
            align-items: center;
            color: #374151;
        }
        .mode-selector input[type="radio"] {
            cursor: pointer;
        }
        .mode-selector span {
            margin-left: 0.5rem;
        }
        textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
            margin-bottom: 1rem;
            background: white;
        }
        textarea:focus {
            outline: none;
            border-color: #6B7280;
        }
        .button {
            background: #1F2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .button:hover {
            background: #374151;
        }
        .hidden {
            display: none;
        }
        .results {
            margin-top: 2rem;
        }
        .result-main {
            background: #10B981;
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .result-main h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .result-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #E5E7EB;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6B7280;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
        }
        .section {
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #E5E7EB;
        }
        .section-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            background: #F9FAFB;
        }
        .section-header:hover {
            background-color: #F3F4F6;
        }
        .section-excluded {
            background: #DBEAFE;
        }
        .section-warning {
            background: #FEF3C7;
        }
        .section-preview {
            background: #D1FAE5;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1F2937;
        }
        .section-count {
            background: white;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1F2937;
            border: 1px solid #E5E7EB;
        }
        .chevron {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.3s;
            color: #6B7280;
        }
        .chevron.open {
            transform: rotate(180deg);
        }
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }
        .section-content.open {
            max-height: 2000px;
            overflow-y: auto;
        }
        .section-content-inner {
            padding: 1rem;
        }
        .item {
            background: white;
            padding: 0.875rem;
            border-radius: 0.375rem;
            margin-bottom: 0.625rem;
            border: 1px solid #E5E7EB;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
        }
        .item-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-excluded {
            background: #BFDBFE;
            color: #1E40AF;
            border: 1px solid #93C5FD;
        }
        .badge-warning {
            background: #FDE68A;
            color: #92400E;
            border: 1px solid #FCD34D;
        }
        .item-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .exclude-button {
            background: #3B82F6;
            color: white;
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .exclude-button:hover {
            background: #2563EB;
        }
        .exclude-button.active {
            background: #EF4444;
        }
        .exclude-button.active:hover {
            background: #DC2626;
        }
        .item-content {
            font-size: 0.875rem;
            color: #374151;
            white-space: pre-wrap;
            font-family: monospace;
            background: #F9FAFB;
            padding: 0.625rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #E5E7EB;
        }
        .preview-text {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 1.25rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #1F2937;
            margin-bottom: 1rem;
        }
        .copy-button {
            background: #1F2937;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }
        .copy-button:hover {
            background: #374151;
        }
        .copy-button.copied {
            background: #6B7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>記事文字数カウンター</h1>
            <p class="subtitle">外注記事をペーストして文字数を自動集計</p>
            
            <div class="mode-selector">
                <label>
                    <input type="radio" name="mode" value="markdown" checked>
                    <span>マークダウン形式</span>
                </label>
                <label>
                    <input type="radio" name="mode" value="wp">
                    <span>WordPress HTML</span>
                </label>
            </div>
            
            <textarea id="input" placeholder="記事をここにペースト..."></textarea>
            <button class="button" id="analyzeBtn">文字数を集計</button>

            <div id="results" class="results hidden">
                <div class="result-main">
                    <h2>最終文字数</h2>
                    <div style="display: flex; align-items: baseline;">
                        <span class="result-number" id="finalCount">0</span>
                        <span class="result-unit">文字</span>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <p class="stat-label">自動除外</p>
                        <p class="stat-value" id="autoCount">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">要確認</p>
                        <p class="stat-value" id="warningCount">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">手動除外</p>
                        <p class="stat-value" id="manualCount">0</p>
                    </div>
                </div>

                <div id="excludedSection" class="section hidden">
                    <div class="section-header section-excluded" onclick="toggle('excluded')">
                        <div class="section-title">
                            <span>自動除外項目</span>
                            <span class="section-count" id="excludedCount">0</span>
                        </div>
                        <svg class="chevron" id="excludedChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="excludedContent">
                        <div class="section-content-inner" id="excludedList"></div>
                    </div>
                </div>

                <div id="warningSection" class="section hidden">
                    <div class="section-header section-warning" onclick="toggle('warning')">
                        <div class="section-title">
                            <span>要確認項目</span>
                            <span class="section-count" id="warningCountBadge">0</span>
                        </div>
                        <svg class="chevron" id="warningChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="warningContent">
                        <div class="section-content-inner">
                            <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">デフォルトで除外されています。文字数に含める場合は「含める」ボタンを押してください。</p>
                            <div id="warningList"></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header section-preview" onclick="toggle('preview')">
                        <div class="section-title">
                            <span>最終テキストプレビュー</span>
                        </div>
                        <svg class="chevron" id="previewChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="previewContent">
                        <div class="section-content-inner">
                            <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">除外後の最終テキストです。</p>
                            <div class="preview-text" id="previewText"></div>
                            <button class="copy-button" id="copyBtn">テキストをコピー</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excludedItems = [];
        let warningItems = [];
        let includedWarnings = new Set(); // Items that should be INCLUDED (opposite of excluded)
        let processedText = '';

        document.getElementById('analyzeBtn').addEventListener('click', analyze);
        document.getElementById('copyBtn').addEventListener('click', copyText);

        function toggle(section) {
            const content = document.getElementById(section + 'Content');
            const chevron = document.getElementById(section + 'Chev');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function analyze() {
            const text = document.getElementById('input').value;
            if (!text.trim()) {
                alert('テキストを入力してください');
                return;
            }

            // モードを取得
            const mode = document.querySelector('input[name="mode"]:checked').value;

            excludedItems = [];
            warningItems = [];
            includedWarnings = new Set();
            
            let working = text;
            const originalCount = text.replace(/\s+/g, '').length;
            const originalText = text;  // 元のテキストを保存（位置計算用）

            // 絵文字を削除
            working = working.replace(/[\u{1F600}-\u{1F64F}\u{1F300}-\u{1F5FF}\u{1F680}-\u{1F6FF}\u{1F700}-\u{1F77F}\u{1F780}-\u{1F7FF}\u{1F800}-\u{1F8FF}\u{1F900}-\u{1F9FF}\u{1FA00}-\u{1FA6F}\u{1FA70}-\u{1FAFF}\u{2600}-\u{26FF}\u{2700}-\u{27BF}\u{1F1E6}-\u{1F1FF}]/gu, '');

            // WPモードの場合は追加の前処理
            if (mode === 'wp') {
                // blockquote, details, img, div.midashi を先に削除
                working = working.replace(/<blockquote[^>]*>[\s\S]*?<\/blockquote>/gi, (match) => {
                    const pos = originalText.indexOf(match);
                    excludedItems.push({ type: 'blockquoteタグ', content: match, position: pos >= 0 ? pos : 999999 });
                    return '';
                });
                
                working = working.replace(/<details[^>]*>[\s\S]*?<\/details>/gi, (match) => {
                    const pos = originalText.indexOf(match);
                    excludedItems.push({ type: 'detailsタグ', content: match, position: pos >= 0 ? pos : 999999 });
                    return '';
                });
                
                working = working.replace(/<img[^>]*>/gi, (match) => {
                    const pos = originalText.indexOf(match);
                    excludedItems.push({ type: 'imgタグ', content: match, position: pos >= 0 ? pos : 999999 });
                    return '';
                });
                
                // すべてのdivタグを削除（開始タグのみ）
                working = working.replace(/<div[^>]*>/gi, '');
                
                // すべての</div>タグを削除（終了タグのみ）
                working = working.replace(/<\/div>/gi, '');

                // ul/ol HTMLリストを要確認項目に追加
                let listHtmlId = 0;
                working = working.replace(/<(ul|ol)[^>]*>[\s\S]*?<\/\1>/gi, (match) => {
                    let textOnly = match;
                    let prevLength;
                    do {
                        prevLength = textOnly.length;
                        textOnly = textOnly.replace(/<[^>]*>/g, '');
                    } while (textOnly.length !== prevLength);
                    
                    const originalPosition = originalText.indexOf(match);
                    warningItems.push({
                        id: `html-list-${listHtmlId++}`,
                        type: 'HTMLリスト',
                        content: match,
                        charCount: textOnly.replace(/\s+/g, '').length,
                        position: originalPosition >= 0 ? originalPosition : 999999
                    });
                    return '';
                });
                
                // HTMLエンティティを削除
                working = working.replace(/&[a-zA-Z]+;/g, (match) => {
                    const pos = originalText.indexOf(match);
                    excludedItems.push({ type: 'HTMLエンティティ', content: match, position: pos >= 0 ? pos : 999999 });
                    return '';
                });
                working = working.replace(/&#[0-9]+;/g, (match) => {
                    const pos = originalText.indexOf(match);
                    excludedItems.push({ type: 'HTMLエンティティ', content: match, position: pos >= 0 ? pos : 999999 });
                    return '';
                });
            }

            // 0. ■ディスクリプションブロックを検出（```で囲まれている場合）
            // ■ディスクリプション部分だけ削除、中身はそのまま残す
            working = working.replace(/```\s*■\s*ディスクリプション\s*([\s\S]*?)```/g, (match, content) => {
                excludedItems.push({ type: '■ディスクリプション', content: '```■ディスクリプション' });
                excludedItems.push({ type: 'コードブロック閉じ', content: '```' });
                return content; // 中身のテキストだけ残す
            });

            // 1. 通常の■ディスクリプション（```で囲まれていない場合）
            working = working.replace(/■\s*ディスクリプション/g, (match) => {
                excludedItems.push({ type: '■ディスクリプション', content: match });
                return '';
            });

            // 2. コードブロックを検出して保護（■ディスクリプション以外の通常のコードブロック）
            const codeBlockMarkers = [];
            let codeBlockId = 0;
            let match;
            const codeBlockRegex = /```[\s\S]*?```/g;
            while ((match = codeBlockRegex.exec(working)) !== null) {
                const marker = `___CODEBLOCK_${codeBlockId}___`;
                const cleanText = match[0].replace(/```/g, '');
                // 元のテキストでの位置を検索
                const originalPosition = originalText.indexOf(match[0]);
                codeBlockMarkers.push({
                    marker: marker,
                    id: `code-${codeBlockId}`,
                    type: 'コードブロック',
                    content: match[0],
                    charCount: cleanText.replace(/\s+/g, '').length,
                    position: originalPosition >= 0 ? originalPosition : 999999  // 見つからない場合は最後に
                });
                codeBlockId++;
            }
            // マーカーに置き換え
            working = working.replace(/```[\s\S]*?```/g, (m, offset) => {
                const block = codeBlockMarkers.find(b => b.content === m);
                return block ? block.marker : m;
            });

            // 3. HTMLコメント
            working = working.replace(/<!--[\s\S]*?-->/g, (match) => {
                excludedItems.push({ type: 'HTMLコメント', content: match });
                return '';
            });

            // 4-10. 行ごと処理
            const lines = working.split('\n');
            const newLines = [];
            let inTable = false;
            let tableLines = [];
            let listLines = [];
            let listId = 0;
            let tableId = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trim = line.trim();

                // テーブル
                if (trim.includes('<table>') || trim.includes('<table ')) {
                    inTable = true;
                    tableLines = [line];
                    continue;
                }
                if (inTable) {
                    tableLines.push(line);
                    if (trim.includes('</table>')) {
                        const tableText = tableLines.join('\n');
                        
                        // 1. まず特定のタグとその中身を削除
                        let textOnly = tableText;
                        
                        // <p id="gdcalert...">...</p> を完全削除
                        textOnly = textOnly.replace(/<p[^>]*id="gdcalert[^"]*"[^>]*>[\s\S]*?<\/p>/gi, '');
                        
                        // <img> タグを削除
                        textOnly = textOnly.replace(/<img[^>]*>/gi, '');
                        
                        // <a> タグとその中身を削除
                        textOnly = textOnly.replace(/<a[^>]*>[\s\S]*?<\/a>/gi, '');
                        
                        // <span> タグとその中身を削除
                        textOnly = textOnly.replace(/<span[^>]*>[\s\S]*?<\/span>/gi, '');
                        
                        // <br> タグを削除
                        textOnly = textOnly.replace(/<br[^>]*>/gi, '');
                        
                        // 2. 残りのHTMLタグを削除（繰り返し適用）
                        let prevLength;
                        do {
                            prevLength = textOnly.length;
                            textOnly = textOnly.replace(/<[^>]*>/g, '');
                        } while (textOnly.length !== prevLength);
                        
                        const originalPosition = originalText.indexOf(tableText);
                        warningItems.push({
                            id: `table-${tableId++}`,
                            type: 'テーブル',
                            content: tableText,
                            charCount: textOnly.replace(/\s+/g, '').length,
                            position: originalPosition >= 0 ? originalPosition : 999999
                        });
                        inTable = false;
                        tableLines = [];
                    }
                    continue;
                }

                // ※で始まる行を除外
                if (trim.startsWith('※')) {
                    excludedItems.push({ type: '※注釈', content: line });
                    continue;
                }

                // 見出し
                const headingPattern = mode === 'wp' 
                    ? /^#{1,6}\s|^<h[2-4][^>]*>|<\/h[2-4]>/
                    : /^#{1,6}\s/;
                if (trim.match(headingPattern)) {
                    excludedItems.push({ type: '見出し', content: line });
                    continue;
                }

                // URL含む行の処理
                if (trim.match(/https?:\/\//)) {
                    // WPモードの場合、URLを含むHTMLタグのみ削除、テキストは残す
                    if (mode === 'wp') {
                        let cleanedLine = line;
                        // <a href="...">...</a> タグを削除
                        cleanedLine = cleanedLine.replace(/<a[^>]*href="[^"]*https?:\/\/[^"]*"[^>]*>[\s\S]*?<\/a>/gi, (match) => {
                            excludedItems.push({ type: 'URLリンクタグ', content: match });
                            return '';
                        });
                        // URL単体が残っている場合はそれも削除
                        cleanedLine = cleanedLine.replace(/https?:\/\/[^\s<]+/g, (match) => {
                            excludedItems.push({ type: 'URL', content: match });
                            return '';
                        });
                        // 空になっていなければ残す
                        if (cleanedLine.trim()) {
                            newLines.push(cleanedLine);
                        }
                        continue;
                    } else {
                        // マークダウンモードは行全体を除外
                        excludedItems.push({ type: 'URL行', content: line });
                        continue;
                    }
                }

                // 画像リンク
                if (trim.startsWith('![')) {
                    excludedItems.push({ type: '画像リンク', content: line });
                    continue;
                }

                // 記号行（* スペースなし含む）
                if (trim.match(/^[★☆○◯●◎◉□■◆◇▲△▼▽►▶◀◄]/) || trim.match(/^\*[^\s]/)) {
                    excludedItems.push({ type: '記号行', content: line });
                    continue;
                }

                // リスト（* スペース付き、•、・）
                if (trim.match(/^\*\s/) || trim.match(/^[•・]/)) {
                    listLines.push(line);
                    continue;
                }

                // 空行でリスト継続チェック
                if (listLines.length > 0 && trim === '') {
                    listLines.push(line);
                    continue;
                }

                // リスト終了
                if (listLines.length > 0) {
                    const listText = listLines.join('\n');
                    // 記号を除外して文字数カウント
                    const cleanText = listText.replace(/^[\*•・]\s*/gm, '');
                    const originalPosition = originalText.indexOf(listText);
                    warningItems.push({
                        id: `list-${listId++}`,
                        type: 'リスト',
                        content: listText,
                        charCount: cleanText.replace(/\s+/g, '').length,
                        position: originalPosition >= 0 ? originalPosition : 999999
                    });
                    listLines = [];
                }

                newLines.push(line);
            }

            // 残りリスト
            if (listLines.length > 0) {
                const listText = listLines.join('\n');
                // 記号を除外して文字数カウント
                const cleanText = listText.replace(/^[\*•・]\s*/gm, '');
                const originalPosition = originalText.indexOf(listText);
                warningItems.push({
                    id: `list-${listId++}`,
                    type: 'リスト',
                    content: listText,
                    charCount: cleanText.replace(/\s+/g, '').length,
                    position: originalPosition >= 0 ? originalPosition : 999999
                });
            }

            working = newLines.join('\n');

            // コードブロックのマーカーを要確認項目に追加してテキストから削除
            codeBlockMarkers.forEach(block => {
                warningItems.push({
                    id: block.id,
                    type: block.type,
                    content: block.content,
                    charCount: block.charCount,
                    position: block.position
                });
                // マーカーを削除
                working = working.replace(block.marker, '');
            });

            // 要確認項目を元のテキストでの出現順にソート
            warningItems.sort((a, b) => (a.position || 0) - (b.position || 0));

            // ** 囲み
            working = working.replace(/\*\*([^*]+?)\*\*/g, (match) => {
                excludedItems.push({ type: '**囲み', content: match });
                return '';
            });

            // * 囲み（行頭以外）
            working = working.replace(/(?<!^)(?<![\n])(?<!\*)\*(?!\*)([^*\n]+?)\*(?!\*)/gm, (match) => {
                excludedItems.push({ type: '*囲み', content: match });
                return '';
            });

            // HTMLタグ（table以外）
            // WPモードの場合: span, ul, ol, liは除外対象から外す / spanタグは削除するが中身は残す
            if (mode === 'wp') {
                // spanタグのみ削除、中身は残す（除外項目には表示しない）
                working = working.replace(/<\/?span[^>]*>/gi, '');
                
                // その他のHTMLタグ（table, ul, ol, li, span以外）
                working = working.replace(/<(?!table|\/table|ul|\/ul|ol|\/ol|li|\/li)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>[\s\S]*?<\/\1>|<(?!table|ul|ol|li)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/gi, (match) => {
                    excludedItems.push({ type: 'HTMLタグ', content: match });
                    return '';
                });
            } else {
                // マークダウンモード: table以外を除外
                working = working.replace(/<(?!table|\/table)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>[\s\S]*?<\/\1>|<(?!table)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/gi, (match) => {
                    excludedItems.push({ type: 'HTMLタグ', content: match });
                    return '';
                });
            }

            // 除外項目を出現順にソート
            excludedItems.sort((a, b) => (a.position || 999999) - (b.position || 999999));

            processedText = working;
            displayResults(originalCount);
        }

        function displayResults(originalCount) {
            document.getElementById('results').classList.remove('hidden');

            // 除外項目表示
            if (excludedItems.length > 0) {
                document.getElementById('excludedSection').classList.remove('hidden');
                document.getElementById('excludedCount').textContent = excludedItems.length;
                const list = document.getElementById('excludedList');
                list.innerHTML = '';
                excludedItems.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="item-badge badge-excluded">${item.type} #${i + 1}</span>
                        </div>
                        <div class="item-content">${escapeHtml(item.content)}</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                document.getElementById('excludedSection').classList.add('hidden');
            }

            // 要確認項目表示
            if (warningItems.length > 0) {
                document.getElementById('warningSection').classList.remove('hidden');
                document.getElementById('warningCountBadge').textContent = warningItems.length;
                const list = document.getElementById('warningList');
                list.innerHTML = '';
                warningItems.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.id = item.id;
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="item-badge badge-warning">${item.type} #${i + 1}</span>
                            <div class="item-actions">
                                <span style="font-size: 0.875rem; font-weight: 600; color: #475569;">${item.charCount.toLocaleString()} 文字</span>
                                <button class="exclude-button" onclick="toggleWarning('${item.id}')">含める</button>
                            </div>
                        </div>
                        <div class="item-content">${escapeHtml(item.content)}</div>
                    `;
                    list.appendChild(div);
                });
            } else {
                document.getElementById('warningSection').classList.add('hidden');
            }

            updateCounts();
            updatePreview();
        }

        function toggleWarning(id) {
            const btn = event.target;
            if (includedWarnings.has(id)) {
                includedWarnings.delete(id);
                btn.textContent = '含める';
                btn.classList.remove('active');
            } else {
                includedWarnings.add(id);
                btn.textContent = '除外';
                btn.classList.add('active');
            }
            updateCounts();
            updatePreview();
        }

        function updateCounts() {
            let finalText = processedText;
            let manualExcluded = 0;
            let manualIncluded = 0;

            // 含めるアイテムの文字数を追加（charCountは既にタグ・記号除外済み）
            warningItems.forEach(item => {
                if (includedWarnings.has(item.id)) {
                    manualIncluded += item.charCount;
                }
            });

            // デフォルト除外（含まれていないwarning items）
            warningItems.forEach(item => {
                if (!includedWarnings.has(item.id)) {
                    manualExcluded += item.charCount;
                }
            });

            const finalCount = finalText.replace(/\s+/g, '').length + manualIncluded;

            document.getElementById('finalCount').textContent = finalCount.toLocaleString();
            document.getElementById('autoCount').textContent = excludedItems.length;
            document.getElementById('warningCount').textContent = warningItems.length;
            document.getElementById('manualCount').textContent = (warningItems.length - includedWarnings.size);
        }

        function updatePreview() {
            let preview = processedText;

            // 含めるアイテムを追加（HTMLタグと記号を削除）
            warningItems.forEach(item => {
                if (includedWarnings.has(item.id)) {
                    let cleanText = item.content;
                    
                    // コードブロックの場合は ``` を削除
                    if (item.type === 'コードブロック') {
                        cleanText = cleanText.replace(/```/g, '');
                    }
                    
                    // テーブルやリストの場合のクリーニング
                    if (item.type === 'テーブル' || item.type === 'リスト' || item.type === 'HTMLリスト') {
                        // 1. まず特定のタグとその中身を削除
                        // <p id="gdcalert...">...</p> を完全削除
                        cleanText = cleanText.replace(/<p[^>]*id="gdcalert[^"]*"[^>]*>[\s\S]*?<\/p>/gi, '');
                        
                        // <img> タグを削除
                        cleanText = cleanText.replace(/<img[^>]*>/gi, '');
                        
                        // <a> タグとその中身を削除
                        cleanText = cleanText.replace(/<a[^>]*>[\s\S]*?<\/a>/gi, '');
                        
                        // <span> タグとその中身を削除
                        cleanText = cleanText.replace(/<span[^>]*>[\s\S]*?<\/span>/gi, '');
                        
                        // <br> タグを削除
                        cleanText = cleanText.replace(/<br[^>]*>/gi, '');
                        
                        // 2. 残りのHTMLタグを削除（繰り返し適用）
                        let prevLength;
                        do {
                            prevLength = cleanText.length;
                            cleanText = cleanText.replace(/<[^>]*>/g, '');
                        } while (cleanText.length !== prevLength);
                        
                        // 3. 箇条書き記号を削除 (*, •, ・)
                        cleanText = cleanText.replace(/^[\*•・]\s*/gm, '');
                    }
                    
                    preview += '\n' + cleanText;
                }
            });

            document.getElementById('previewText').textContent = preview;
        }

        function copyText() {
            const text = document.getElementById('previewText').textContent;
            const btn = document.getElementById('copyBtn');
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'コピーしました！';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'テキストをコピー';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>
