<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>記事文字数カウンター</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #FAFAFA;
            min-height: 100vh;
            padding: 2rem;
        }
        .container {
            max-width: 64rem;
            margin: 0 auto;
        }
        .card {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            border: 1px solid #E5E7EB;
        }
        h1 {
            font-size: 2rem;
            font-weight: 700;
            color: #1F2937;
            margin-bottom: 0.5rem;
        }
        .subtitle {
            color: #6B7280;
            margin-bottom: 1.5rem;
        }
        textarea {
            width: 100%;
            min-height: 400px;
            padding: 1rem;
            border: 1px solid #D1D5DB;
            border-radius: 0.5rem;
            font-family: monospace;
            font-size: 0.875rem;
            resize: vertical;
            margin-bottom: 1rem;
            background: white;
        }
        textarea:focus {
            outline: none;
            border-color: #6B7280;
        }
        .button {
            background: #1F2937;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
        }
        .button:hover {
            background: #374151;
        }
        .hidden {
            display: none;
        }
        .results {
            margin-top: 2rem;
        }
        .result-main {
            background: #10B981;
            color: white;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin-bottom: 1.5rem;
        }
        .result-main h2 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .result-number {
            font-size: 2.5rem;
            font-weight: 700;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .stat-card {
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            border: 1px solid #E5E7EB;
        }
        .stat-label {
            font-size: 0.875rem;
            color: #6B7280;
            margin-bottom: 0.5rem;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1F2937;
        }
        .section {
            background: white;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            border: 1px solid #E5E7EB;
        }
        .section-header {
            padding: 1rem;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
            background: #F9FAFB;
        }
        .section-header:hover {
            background-color: #F3F4F6;
        }
        .section-excluded {
            background: #DBEAFE;
        }
        .section-warning {
            background: #FEF3C7;
        }
        .section-preview {
            background: #D1FAE5;
        }
        .section-title {
            font-size: 1rem;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #1F2937;
        }
        .section-count {
            background: white;
            padding: 0.25rem 0.625rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            font-weight: 600;
            color: #1F2937;
            border: 1px solid #E5E7EB;
        }
        .chevron {
            width: 1.25rem;
            height: 1.25rem;
            transition: transform 0.3s;
            color: #6B7280;
        }
        .chevron.open {
            transform: rotate(180deg);
        }
        .section-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s;
        }
        .section-content.open {
            max-height: 2000px;
            overflow-y: auto;
        }
        .section-content-inner {
            padding: 1rem;
        }
        .item {
            background: white;
            padding: 0.875rem;
            border-radius: 0.375rem;
            margin-bottom: 0.625rem;
            border: 1px solid #E5E7EB;
        }
        .item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.625rem;
        }
        .item-badge {
            padding: 0.25rem 0.625rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .badge-excluded {
            background: #BFDBFE;
            color: #1E40AF;
            border: 1px solid #93C5FD;
        }
        .badge-warning {
            background: #FDE68A;
            color: #92400E;
            border: 1px solid #FCD34D;
        }
        .item-actions {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }
        .exclude-button {
            background: #3B82F6;
            color: white;
            padding: 0.375rem 0.75rem;
            border: none;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
            cursor: pointer;
        }
        .exclude-button:hover {
            background: #2563EB;
        }
        .exclude-button.active {
            background: #EF4444;
        }
        .exclude-button.active:hover {
            background: #DC2626;
        }
        .item-content {
            font-size: 0.875rem;
            color: #374151;
            white-space: pre-wrap;
            font-family: monospace;
            background: #F9FAFB;
            padding: 0.625rem;
            border-radius: 0.25rem;
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #E5E7EB;
        }
        .preview-text {
            background: #F9FAFB;
            border: 1px solid #E5E7EB;
            border-radius: 0.5rem;
            padding: 1.25rem;
            max-height: 500px;
            overflow-y: auto;
            white-space: pre-wrap;
            font-family: monospace;
            font-size: 0.875rem;
            line-height: 1.6;
            color: #1F2937;
            margin-bottom: 1rem;
        }
        .copy-button {
            background: #1F2937;
            color: white;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            font-weight: 600;
            cursor: pointer;
        }
        .copy-button:hover {
            background: #374151;
        }
        .copy-button.copied {
            background: #6B7280;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="card">
            <h1>記事文字数カウンター</h1>
            <p class="subtitle">外注記事をペーストして文字数を自動集計</p>
            
            <textarea id="input" placeholder="マークダウン形式の記事をここにペースト..."></textarea>
            <button class="button" id="analyzeBtn">文字数を集計</button>

            <div id="results" class="results hidden">
                <div class="result-main">
                    <h2>最終文字数</h2>
                    <p class="result-number"><span id="finalCount">0</span> 文字</p>
                    <p style="font-size: 0.875rem; margin-top: 0.5rem; opacity: 0.9;">除外項目を反映した文字数</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <p class="stat-label">自動除外</p>
                        <p class="stat-value" id="autoCount">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">要確認</p>
                        <p class="stat-value" id="warningCount">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="stat-label">手動除外</p>
                        <p class="stat-value" id="manualCount">0</p>
                    </div>
                </div>

                <div id="excludedSection" class="section hidden">
                    <div class="section-header section-excluded" onclick="toggle('excluded')">
                        <div class="section-title">
                            <span>自動除外項目</span>
                            <span class="section-count" id="excludedCount">0</span>
                        </div>
                        <svg class="chevron" id="excludedChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="excludedContent">
                        <div class="section-content-inner" id="excludedList"></div>
                    </div>
                </div>

                <div id="warningSection" class="section hidden">
                    <div class="section-header section-warning" onclick="toggle('warning')">
                        <div class="section-title">
                            <span>要確認項目</span>
                            <span class="section-count" id="warningCountBadge">0</span>
                        </div>
                        <svg class="chevron" id="warningChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="warningContent">
                        <div class="section-content-inner">
                            <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">デフォルトで除外されています。文字数に含める場合は「含める」ボタンを押してください。</p>
                            <div id="warningList"></div>
                        </div>
                    </div>
                </div>

                <div class="section">
                    <div class="section-header section-preview" onclick="toggle('preview')">
                        <div class="section-title">
                            <span>最終テキストプレビュー</span>
                        </div>
                        <svg class="chevron" id="previewChev" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                        </svg>
                    </div>
                    <div class="section-content" id="previewContent">
                        <div class="section-content-inner">
                            <p style="font-size: 0.875rem; color: #6B7280; margin-bottom: 1rem;">除外後の最終テキストです。</p>
                            <div class="preview-text" id="previewText"></div>
                            <button class="copy-button" id="copyBtn">テキストをコピー</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let excludedItems = [];
        let warningItems = [];
        let includedWarnings = new Set(); // Items that should be INCLUDED (opposite of excluded)
        let processedText = '';

        document.getElementById('analyzeBtn').addEventListener('click', analyze);
        document.getElementById('copyBtn').addEventListener('click', copyText);

        function toggle(section) {
            const content = document.getElementById(section + 'Content');
            const chevron = document.getElementById(section + 'Chev');
            content.classList.toggle('open');
            chevron.classList.toggle('open');
        }

        function analyze() {
            const text = document.getElementById('input').value;
            if (!text.trim()) {
                alert('テキストを入力してください');
                return;
            }

            excludedItems = [];
            warningItems = [];
            includedWarnings = new Set();
            
            let working = text;
            const originalCount = text.replace(/\s+/g, '').length;

            // 1. HTMLコメント
            working = working.replace(/<!--[\s\S]*?-->/g, (match) => {
                excludedItems.push({ type: 'HTMLコメント', content: match });
                return '';
            });

            // 2. コードブロック
            working = working.replace(/```[\s\S]*?```/g, (match) => {
                excludedItems.push({ type: 'コードブロック', content: match });
                return '';
            });

            // 3. ■ディスクリプション
            working = working.replace(/■ディスクリプション/g, (match) => {
                excludedItems.push({ type: 'ディスクリプション', content: match });
                return '';
            });

            // 4-10. 行ごと処理
            const lines = working.split('\n');
            const newLines = [];
            let inTable = false;
            let tableLines = [];
            let listLines = [];
            let listId = 0;
            let tableId = 0;

            for (let i = 0; i < lines.length; i++) {
                const line = lines[i];
                const trim = line.trim();

                // テーブル
                if (trim.includes('<table>') || trim.includes('<table ')) {
                    inTable = true;
                    tableLines = [line];
                    continue;
                }
                if (inTable) {
                    tableLines.push(line);
                    if (trim.includes('</table>')) {
                        const tableText = tableLines.join('\n');
                        
                        // 1. まず特定のタグとその中身を削除
                        let textOnly = tableText;
                        
                        // <p id="gdcalert...">...</p> を完全削除
                        textOnly = textOnly.replace(/<p[^>]*id="gdcalert[^"]*"[^>]*>[\s\S]*?<\/p>/gi, '');
                        
                        // <img> タグを削除
                        textOnly = textOnly.replace(/<img[^>]*>/gi, '');
                        
                        // <a> タグとその中身を削除
                        textOnly = textOnly.replace(/<a[^>]*>[\s\S]*?<\/a>/gi, '');
                        
                        // <span> タグとその中身を削除
                        textOnly = textOnly.replace(/<span[^>]*>[\s\S]*?<\/span>/gi, '');
                        
                        // <br> タグを削除
                        textOnly = textOnly.replace(/<br[^>]*>/gi, '');
                        
                        // 2. 残りのHTMLタグを削除（繰り返し適用）
                        let prevLength;
                        do {
                            prevLength = textOnly.length;
                            textOnly = textOnly.replace(/<[^>]*>/g, '');
                        } while (textOnly.length !== prevLength);
                        
                        warningItems.push({
                            id: `table-${tableId++}`,
                            type: 'テーブル',
                            content: tableText,
                            charCount: textOnly.replace(/\s+/g, '').length
                        });
                        inTable = false;
                        tableLines = [];
                    }
                    continue;
                }

                // 見出し
                if (trim.match(/^#{1,6}\s/)) {
                    excludedItems.push({ type: '見出し', content: line });
                    continue;
                }

                // URL行
                if (trim.match(/https?:\/\//)) {
                    excludedItems.push({ type: 'URL行', content: line });
                    continue;
                }

                // 画像リンク
                if (trim.startsWith('![')) {
                    excludedItems.push({ type: '画像リンク', content: line });
                    continue;
                }

                // 記号行（* スペースなし含む）
                if (trim.match(/^[★☆○◯●◎◉□■◆◇▲△▼▽►▶◀◄]/) || trim.match(/^\*[^\s]/)) {
                    excludedItems.push({ type: '記号行', content: line });
                    continue;
                }

                // リスト（* スペース付き、•、・）
                if (trim.match(/^\*\s/) || trim.match(/^[•・]/)) {
                    listLines.push(line);
                    continue;
                }

                // 空行でリスト継続チェック
                if (listLines.length > 0 && trim === '') {
                    listLines.push(line);
                    continue;
                }

                // リスト終了
                if (listLines.length > 0) {
                    const listText = listLines.join('\n');
                    // 記号を除外して文字数カウント
                    const cleanText = listText.replace(/^[\*•・]\s*/gm, '');
                    warningItems.push({
                        id: `list-${listId++}`,
                        type: 'リスト',
                        content: listText,
                        charCount: cleanText.replace(/\s+/g, '').length
                    });
                    listLines = [];
                }

                newLines.push(line);
            }

            // 残りリスト
            if (listLines.length > 0) {
                const listText = listLines.join('\n');
                // 記号を除外して文字数カウント
                const cleanText = listText.replace(/^[\*•・]\s*/gm, '');
                warningItems.push({
                    id: `list-${listId++}`,
                    type: 'リスト',
                    content: listText,
                    charCount: cleanText.replace(/\s+/g, '').length
                });
            }

            working = newLines.join('\n');

            // ** 囲み
            working = working.replace(/\*\*([^*]+?)\*\*/g, (match) => {
                excludedItems.push({ type: '**囲み', content: match });
                return '';
            });

            // * 囲み（行頭以外）
            working = working.replace(/(?<!^)(?<![\n])(?<!\*)\*(?!\*)([^*\n]+?)\*(?!\*)/gm, (match) => {
                excludedItems.push({ type: '*囲み', content: match });
                return '';
            });

            // HTMLタグ（table以外）
            working = working.replace(/<(?!table|\/table)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>[\s\S]*?<\/\1>|<(?!table)([a-zA-Z][a-zA-Z0-9]*)\b[^>]*>/gi, (match) => {
                excludedItems.push({ type: 'HTMLタグ', content: match });
                return '';
            });

            processedText = working;
            displayResults(originalCount);
        }

        function displayResults(originalCount) {
            document.getElementById('results').classList.remove('hidden');

            // 除外項目表示
            if (excludedItems.length > 0) {
                document.getElementById('excludedSection').classList.remove('hidden');
                document.getElementById('excludedCount').textContent = excludedItems.length;
                const list = document.getElementById('excludedList');
                list.innerHTML = '';
                excludedItems.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="item-badge badge-excluded">${item.type} #${i + 1}</span>
                        </div>
                        <div class="item-content">${escapeHtml(item.content)}</div>
                    `;
                    list.appendChild(div);
                });
            }

            // 要確認項目表示
            if (warningItems.length > 0) {
                document.getElementById('warningSection').classList.remove('hidden');
                document.getElementById('warningCountBadge').textContent = warningItems.length;
                const list = document.getElementById('warningList');
                list.innerHTML = '';
                warningItems.forEach((item, i) => {
                    const div = document.createElement('div');
                    div.className = 'item';
                    div.id = item.id;
                    div.innerHTML = `
                        <div class="item-header">
                            <span class="item-badge badge-warning">${item.type} #${i + 1}</span>
                            <div class="item-actions">
                                <span style="font-size: 0.875rem; font-weight: 600; color: #475569;">${item.charCount.toLocaleString()} 文字</span>
                                <button class="exclude-button" onclick="toggleWarning('${item.id}')">含める</button>
                            </div>
                        </div>
                        <div class="item-content">${escapeHtml(item.content)}</div>
                    `;
                    list.appendChild(div);
                });
            }

            updateCounts();
            updatePreview();
        }

        function toggleWarning(id) {
            const btn = event.target;
            if (includedWarnings.has(id)) {
                includedWarnings.delete(id);
                btn.textContent = '含める';
                btn.classList.remove('active');
            } else {
                includedWarnings.add(id);
                btn.textContent = '除外';
                btn.classList.add('active');
            }
            updateCounts();
            updatePreview();
        }

        function updateCounts() {
            let finalText = processedText;
            let manualExcluded = 0;
            let manualIncluded = 0;

            // 含めるアイテムの文字数を追加（charCountは既にタグ・記号除外済み）
            warningItems.forEach(item => {
                if (includedWarnings.has(item.id)) {
                    manualIncluded += item.charCount;
                }
            });

            // デフォルト除外（含まれていないwarning items）
            warningItems.forEach(item => {
                if (!includedWarnings.has(item.id)) {
                    manualExcluded += item.charCount;
                }
            });

            const finalCount = finalText.replace(/\s+/g, '').length + manualIncluded;

            document.getElementById('finalCount').textContent = finalCount.toLocaleString();
            document.getElementById('autoCount').textContent = excludedItems.length;
            document.getElementById('warningCount').textContent = warningItems.length;
            document.getElementById('manualCount').textContent = (warningItems.length - includedWarnings.size);
        }

        function updatePreview() {
            let preview = processedText;

            // 含めるアイテムを追加（HTMLタグと記号を削除）
            warningItems.forEach(item => {
                if (includedWarnings.has(item.id)) {
                    let cleanText = item.content;
                    
                    // 1. まず特定のタグとその中身を削除
                    // <p id="gdcalert...">...</p> を完全削除
                    cleanText = cleanText.replace(/<p[^>]*id="gdcalert[^"]*"[^>]*>[\s\S]*?<\/p>/gi, '');
                    
                    // <img> タグを削除
                    cleanText = cleanText.replace(/<img[^>]*>/gi, '');
                    
                    // <a> タグとその中身を削除
                    cleanText = cleanText.replace(/<a[^>]*>[\s\S]*?<\/a>/gi, '');
                    
                    // <span> タグとその中身を削除
                    cleanText = cleanText.replace(/<span[^>]*>[\s\S]*?<\/span>/gi, '');
                    
                    // <br> タグを削除
                    cleanText = cleanText.replace(/<br[^>]*>/gi, '');
                    
                    // 2. 残りのHTMLタグを削除（繰り返し適用）
                    let prevLength;
                    do {
                        prevLength = cleanText.length;
                        cleanText = cleanText.replace(/<[^>]*>/g, '');
                    } while (cleanText.length !== prevLength);
                    
                    // 3. 箇条書き記号を削除 (*, •, ・)
                    cleanText = cleanText.replace(/^[\*•・]\s*/gm, '');
                    
                    preview += '\n' + cleanText;
                }
            });

            document.getElementById('previewText').textContent = preview;
        }

        function copyText() {
            const text = document.getElementById('previewText').textContent;
            const btn = document.getElementById('copyBtn');
            navigator.clipboard.writeText(text).then(() => {
                btn.textContent = 'コピーしました！';
                btn.classList.add('copied');
                setTimeout(() => {
                    btn.textContent = 'テキストをコピー';
                    btn.classList.remove('copied');
                }, 2000);
            });
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
    </script>
</body>
</html>